<!DOCTYPE html>
<html ng-app="reservationModify" lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0" />
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/button.css">
    <style>
      form div {
        margin: 5px 0;
      }

      .int label {
        width: 100px;
        float: left;
        text-align: right;
      }

      .int input {
        padding: 1px 1px;
        border: 1px solid #ccc;
        height: 16px;
      }
    </style>
    <script src="https://code.angularjs.org/1.7.5/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.7.5/angular-cookies.min.js"></script>
    <script>
      var app = angular.module("reservationModify", ['ngCookies']);
      app.controller('reservationModifyController', function ($cookies, $scope, $http, $filter) {
        $scope.canModify = false;
        $scope.canSignin = false;
        $scope.reserveVO.reservationInfoId = "";
        $scope.reserveVO.linkManName = "";
        $scope.reserveVO.sex = "MALE";
        $scope.reserveVO.age = "";
        $scope.reserveVO.phoneNumber = "";
        $scope.reserveVO.peopleCount = "";
        $scope.reserveVO.activityType = "TEAM";
        $scope.reserveVO.signIn = false;
        $scope.load = function () {
          var href = location.href;
          var urlValue = href.substr(href.indexOf("=") + 1);
          $scope.reserveVO.reservationInfoId = urlValue;
          $http({
            method: 'GET',
            url: 'http://yp.compass-trip.com:8081/platform/reserve/modify?token=' + $cookies.get('token') + '&reservationInfoId=' + $scope.reserveVO.reservationInfoId,
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if (resp.data != null) {
              $scope.reserveVO.reservationInfoId = resp.data.reservationInfoId;
              $scope.reserveVO.linkManName = resp.data.linkManName;
              $scope.reserveVO.sex = resp.data.sex;
              $scope.reserveVO.age = resp.data.age;
              $scope.reserveVO.phoneNumber = resp.data.phoneNumber;
              $scope.reserveVO.peopleCount = resp.data.peopleCount;
              $scope.reserveVO.activityType = resp.data.activityType;
              $scope.reserveVO.reserveBegin = new Date(resp.data.reserveBegin);
              $scope.reserveVO.reserveEnd = new Date(resp.data.reserveEnd);
              $scope.reserveVO.signIn = resp.data.signIn;
              var now = $filter("date")(new Date(), "yyyyMMdd");
              var startDate = $filter("date")($scope.reserveVO.reserveBegin, "yyyyMMdd");
              $scope.canModify = startDate > now;
              $scope.canSignin = startDate <= now && !$scope.reserveVO.signIn;
            } else {
              alert("不可修改！重新登录");
              self.location = 'login.html';
            }
          }, function (resp) {
            alert("修改失败！服务调用失败！跳转到登录页面");
            self.location = 'login.html';
          });
        };

        $scope.back = function () {
          self.location = 'reservationList.html';
        };

        $scope.signin = function () {
          $http({
            method: 'POST',
            url: 'http://yp.compass-trip.com:8081/platform/reserve/signin?token=' + $cookies.get('token'),
            data: {
              "reservationInfoId": $scope.reserveVO.reservationInfoId
            },
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if (resp.data != null && resp.data != '') {
              alert("签到成功！");
              self.location = 'reservationList.html';
            } else {
              alert("签到失败！");
            }
          }, function (resp) {
            alert("修改失败！服务调用失败！跳转到登录页面");
            self.location = 'login.html';
          });
        };

        $scope.cancel = function () {
          $http({
            method: 'POST',
            url: 'http://yp.compass-trip.com:8081/platform/reserve/cancel?token=' + $cookies.get('token'),
            data: {
              "reservationInfoId": $scope.reserveVO.reservationInfoId
            },
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if (resp.data != null && resp.data != '') {
              alert("取消成功！");
              self.location = 'reservationList.html';
            } else {
              alert("取消失败！");
            }
          }, function (resp) {
            alert("取消失败！服务调用失败！跳转到登录页面");
            self.location = 'login.html';
          });
        };

        $scope.reserveForm = function () {
          $http({
            method: 'POST',
            url: 'http://yp.compass-trip.com:8081/platform/reserve?token=' + $cookies.get('token'),
            data: {
              "reservationInfoId": $scope.reserveVO.reservationInfoId,
              "linkManName": $scope.reserveVO.linkManName,
              "sex": $scope.reserveVO.sex,
              "age": $scope.reserveVO.age,
              "phoneNumber": $scope.reserveVO.phoneNumber,
              "reserveBegin": $scope.reserveVO.reserveBegin,
              "reserveEnd": $scope.reserveVO.reserveEnd,
              "peopleCount": $scope.reserveVO.peopleCount,
              "activityType": $scope.reserveVO.activityType
            },
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if (resp.data == true) {
              alert("修改成功！");
              self.location = 'reservationList.html';
            } else {
              alert("修改失败！");
            }
          }, function (resp) {
            alert("修改失败！服务调用失败！跳转到登录页面");
            self.location = 'login.html';
          });
        };

        $scope.logout = function () {
          $cookies.put("user", null);
          $cookies.put("token", null);
          location.href = 'login.html';
        };

      });
    </script>
    <title>资源预约</title>
  </head>
  <body>
    <div class="header">
      <div>
        <a class="home" href="reservation.html" title="预约"><i></i></a>
        <a class="more" href="reservationList.html" title="预约一览"><i></i></a>
        <span id="lblTitle">预约系统</span>
      </div>
    </div>
    <div>
      <img class="header-image" src="img/hd-bg.jpeg">
    </div>
    <div class="middle">
      <div ng-controller="reservationModifyController as reserveVO" class="main" data-ng-init="load()">
        <div>
          <form ng-submit="reserveForm()">
            <div class="int">
              <label>联系人姓名:</label><input type="text" ng-model="reserveVO.linkManName" readonly  unselectable="on" />
            </div>
            <div class="int">
              <label>性别:</label>
              <input name="sex" type="radio" ng-model="reserveVO.sex" value="MALE" disabled/>男
              <input name="sex" type="radio" ng-model="reserveVO.sex" value="FEMALE" disabled/>女
            </div>
            <div class="int">
              <label>年龄:</label><input type="number" ng-maxlength="2" string-to-number ng-model="reserveVO.age" readonly  unselectable="on"/>
            </div>
            <div class="int">
              <label>电话号码:</label><input type="text" ng-maxlength="15" string-to-number ng-model="reserveVO.phoneNumber" readonly  unselectable="on" />
            </div>
            <div class="int">
              <label>预约开始日期:</label><input type="date" ng-model="reserveVO.reserveBegin" readonly  unselectable="on" />
            </div>
            <div class="int">
              <label>预约结束日期:</label><input type="date" ng-model="reserveVO.reserveEnd" readonly  unselectable="on" />
            </div>
            <div class="int">
              <label>预约人数:</label><input type="number" ng-maxlength="4" ng-model="reserveVO.peopleCount" readonly  unselectable="on" />
            </div>
            <div class="int">
              <label>预约类型:</label>
              <input name="activityType" type="radio" ng-model="reserveVO.activityType" value="TEAM" disabled/>团队
              <input name="activityType" type="radio" ng-model="reserveVO.activityType" value="SINGLE" disabled/>个人
            </div>
            <button ng-if="canSignin" type="button" class="button button-glow button-rounded button-raised button-primary button-tiny" style="margin-bottom: 10px" ng-click="signin()">签到</button>
            <button ng-if="canModify" type="button" class="button button-glow button-rounded button-raised button-primary button-tiny" style="margin-bottom: 10px" ng-click="cancel()">取消预约</button>
            <button type="button" class="button button-glow button-rounded button-raised button-primary button-tiny" style="margin-bottom: 10px" ng-click="back()">返回</button>
            <button type="button" class="button button-glow button-border button-rounded button-primary button-tiny" style="margin-bottom: 10px" ng-click="logout()">退出</button>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>