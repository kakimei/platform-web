<!DOCTYPE html>
<html ng-app="reservationModify" lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0" />
    <style>
      body {
        height: 800px;
      }

      .header {
        width: 100%;
        height: 5%;
        background-color: lightblue;
      }

      .main {
        float: right;
        width: 100%;
        height: 75%;
        background-color: whitesmoke;
      }

      .footer {
        clear: both;
        width: 100%;
        height: 10%;
        background-color: darkgray;
      }

      .btn.blue { background: #2ae; }
    </style>
    <script src="https://code.angularjs.org/1.7.5/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.7.5/angular-cookies.min.js"></script>
    <script>
      var app = angular.module("reservationModify", ['ngCookies']);
      app.controller('reservationModifyController', function ($cookies, $scope, $http, $filter) {
        $scope.canModify = false;
        $scope.canSignin = false;
        $scope.reserveVO.reservationInfoId="";
        $scope.reserveVO.linkManName="";
        $scope.reserveVO.sex = "MALE";
        $scope.reserveVO.age = "";
        $scope.reserveVO.phoneNumber = "";
        $scope.reserveVO.peopleCount = "";
        $scope.reserveVO.activityType = "TEAM";
        $scope.reserveVO.signIn = false;
        $scope.load = function () {
          var href = location.href;
          var urlValue = href.substr(href.indexOf("=") + 1);
          $scope.reserveVO.reservationInfoId = urlValue;
          $http({
            method: 'GET',
            url: 'http://localhost:8081/platform/reserve/modify?token='+$cookies.get('token')+'&reservationInfoId='+$scope.reserveVO.reservationInfoId,
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if(resp.data != null){
              $scope.reserveVO.reservationInfoId = resp.data.reservationInfoId;
              $scope.reserveVO.linkManName = resp.data.linkManName;
              $scope.reserveVO.sex = resp.data.sex;
              $scope.reserveVO.age = resp.data.age;
              $scope.reserveVO.phoneNumber = resp.data.phoneNumber;
              $scope.reserveVO.peopleCount = resp.data.peopleCount;
              $scope.reserveVO.reserveBegin = new Date(resp.data.reserveBegin);
              $scope.reserveVO.reserveEnd = new Date(resp.data.reserveEnd);
              $scope.reserveVO.signIn = resp.data.signIn;
              var now = $filter("date")(new Date(), "yyyyMMdd");
              var startDate = $filter("date")($scope.reserveVO.reserveBegin, "yyyyMMdd");
              $scope.canModify = startDate > now;
              $scope.canSignin = startDate <= now && !$scope.reserveVO.signIn;
            }else{
              alert("不可修改！重新登录");
              self.location='login.html';
            }
          }, function (resp) {
            alert("修改失败！服务调用失败！跳转到登录页面");
            self.location='login.html';
          });
        };

        $scope.back = function () {
          self.location='reservationList.html';
        };

        $scope.signin = function () {
          $http({
            method: 'POST',
            url: 'http://localhost:8081/platform/reserve/signin?token='+$cookies.get('token'),
            data: {
              "reservationInfoId": $scope.reserveVO.reservationInfoId
            },
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if(resp.data != null && resp.data != ''){
              alert("签到成功！");
              self.location='reservationList.html';
            }else{
              alert("签到失败！");
            }
          }, function (resp) {
            alert("修改失败！服务调用失败！跳转到登录页面");
            self.location='login.html';
          });
        };

        $scope.reserveForm = function () {
          $http({
            method: 'POST',
            url: 'http://localhost:8081/platform/reserve?token='+$cookies.get('token'),
            data: {
              "reservationInfoId": $scope.reserveVO.reservationInfoId,
              "linkManName": $scope.reserveVO.linkManName,
              "sex": $scope.reserveVO.sex,
              "age": $scope.reserveVO.age,
              "phoneNumber": $scope.reserveVO.phoneNumber,
              "reserveBegin": $scope.reserveVO.reserveBegin,
              "reserveEnd": $scope.reserveVO.reserveEnd,
              "peopleCount": $scope.reserveVO.peopleCount,
              "activityType": $scope.reserveVO.activityType
            },
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(function (resp) {
            if(resp.data == true){
              alert("修改成功！");
              self.location='reservationList.html';
            }else{
              alert("修改失败！");
            }
          }, function (resp) {
            alert("修改失败！服务调用失败！跳转到登录页面");
            self.location='login.html';
          });
        }
      });
    </script>
    <title>资源预约</title>
  </head>
  <body>
    <div class="header">预约系统</div>
    <div ng-controller="reservationModifyController as reserveVO" class="main" data-ng-init="load()">
      <form ng-submit="reserveForm()">
        联系人姓名:<input type="text" ng-model="reserveVO.linkManName" required/> <br />
        性别:
        <input name="sex" type="radio" ng-model="reserveVO.sex" value="MALE"/>男
        <input name="sex" type="radio" ng-model="reserveVO.sex" value="FEMALE"/>女<br />
        年龄:<input type="number" ng-maxlength="2" string-to-number ng-model="reserveVO.age" /> <br />
        电话号码:<input type="text" ng-maxlength="15" string-to-number ng-model="reserveVO.phoneNumber" required/> <br />
        预约开始日期:<input type="date" ng-model="reserveVO.reserveBegin" required/> <br />
        预约结束日期:<input type="date" ng-model="reserveVO.reserveEnd" required/> <br />
        预约人数:<input type="number" ng-maxlength="4" ng-model="reserveVO.peopleCount" required/> <br />
        预约类型:
        <input name="activityType" type="radio" ng-model="reserveVO.activityType" value="TEAM"/>团队
        <input name="activityType" type="radio" ng-model="reserveVO.activityType" value="SINGLE" />个人<br />
        <button ng-if="canModify" type="submit" class="btn blue">修改</button>
        <button ng-if="canSignin" type="button" class="btn blue" ng-click="signin()">签到</button>
        <button type="button" class="btn blue" ng-click="back()">返回</button>
      </form>
    </div>
  </body>
</html>